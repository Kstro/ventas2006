{% extends 'hnrsircimBundle::Layout.html.twig' %}

{% block stylesheets %}
   {{ parent() }}
   {# <link href="{{ asset('bundles/hnrsircim/js/jquery-ui-1.10.3.custom/css/custom-theme/jquery-ui-1.10.3.custom.css') }}" rel="stylesheet" type="text/css" /> #}
   <link href="{{ asset('bundles/hnrsircim/js/Zebra_Datepicker-master/public/css/metallic.css') }}" rel="stylesheet" type="text/css" /> 
   <link href="{{ asset('bundles/hnrsircim/js/wdContextMenu/css/contextmenu.css') }}" rel="stylesheet" type="text/css" /> 
   <link href="{{ asset('bundles/hnrsircim/js/custom-scrollbar-plugin/jquery.mCustomScrollbar.css') }}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block nombre_usr %}
    <label id="{{ login }}">
        {{ login }}
    </label> 
{% endblock %} 

{% block lista_modulos %}
    {% for modulo in modulos %}
        <li><a href="{{path(modulo.osURL,{'login':usuario})}}">{{modulo}}</a></li>
    {% endfor %}
{% endblock %}

{% block configuracion %}
    
    <a id="conf_cuenta" href="{{ path('usuario_cuenta', { 'login':login,'opc':'0' }) }}">Configuración de cuenta</a>

{% endblock %}

{% block javascripts %}
   {{ parent() }}
   {# <script type="text/javascript" src="{{ asset('bundles/hnrsircim/js/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.min.js') }}" ></script> #}
   <script type="text/javascript" src="{{ asset('bundles/hnrsircim/js/Zebra_Datepicker-master/public/javascript/zebra_datepicker.js') }}" ></script>   
   <script type="text/javascript" src="{{ asset('bundles/hnrsircim/js/wdContextMenu/src/Plugins/jquery.contextmenu.js') }}" ></script>
   <script type="text/javascript" src="{{ asset('bundles/hnrsircim/js/custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js') }}" ></script>
   <script src="{{ asset('bundles/hnrsircim/js/Modulos/bitacora/mostrarbitacora.js') }}" type="text/javascript"></script>
{% endblock %}

{% block mod_activo %} Programación de citas {% endblock %}   
   
{% block botones_modulo %} 
    <div class="menu_grupo"> 
        <button class="btn btn_destacado" id="buscar" title="Buscar"></button>
        {#<button class="btn btn_destacado" id="nuevo" title="Nueva cita" onclick="location.href='{{ path('cita_new') }}';"></button>       #}
        <button class="btn btn_destacado" id="nuevo" title="Nueva cita" href="{{ path('cita_new',{'login':login}) }}"></button>
    </div>

    <div class="menu_grupo">
        <input type="radio" id="input_mes" name="toggle"/>
        <label class="btn btn_regular btn_toggle primero" for="input_mes">Mes</label>
        
        <input type="radio" id="input_semana" name="toggle"/>
        <label class="btn btn_regular btn_toggle medio" for="input_semana" href="{{ path('cita_semana',{'login':login}) }}">Semana</label>
        
        <input type="radio" id="input_dia" name="toggle" checked="checked"/>
        <label class="btn btn_regular btn_toggle ultimo checked" for="input_dia">Día</label>
    </div>

    <div class="menu_grupo"> 
        {# <button class="btn btn_regular btn_hoy" title="Hoy" onclick="alert('{{"now"|date('d-m-Y')}}')">Hoy</button> #}
        <button class="btn btn_regular btn_hoy" id="hoy" title="Hoy">Hoy</button>    
    </div>

    <div id="busqueda">
        <form>
         <table>
           <tr>
             <td>
                 Paciente :
             </td>
             <td>
                 <input type="text" id="busq_registro"/>
             </td>
           </tr>
           <tr>
             <td>
                 <input type="checkbox" name="checkbox" id="checkbox_id2" value="value"/>
                 <label for="checkbox_id2"><span></span>Estudio :</label>
             </td>
             <td>
                 <select name="Single-line ListBox example" id="busq_estudio">
                    <option value="1">Ultrasonografía</option>
                    <option value="2">Tránsito intestinal</option>
                 </select>
             </td>
           </tr>
           <tr>
             <td>
                 <input type="checkbox" name="checkbox" id="checkbox_id3" value="value"/>
                 <label for="checkbox_id3"><span></span>Rango de fechas :</label>
                     {#<select id="busq_modo" name="Single-line ListBox example">
                       <option value="1">Rango de Fechas</option>                       
                     </select>#}
                 
             </td>
             <td>
                 <input type="text" id="busq_fecha1" class="fecha_rango"/> - <input type="text" id="busq_fecha2" class="fecha_rango"/>
             </td>
           </tr>
           <tr>
             <td>
                 <input type="checkbox" name="checkbox" id="checkbox_id4" value="value"/>
                 <label for="checkbox_id4"><span></span>Estado :</label>
             </td>
             <td>
                 <select id="busq_estado" name="Single-line ListBox example">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Asistida">Asistida</option>
                    <option value="No Asistida">No Asistida</option>
                    <option value="Cancelada">Cancelada</option>
                 </select>
             </td>
           </tr>
           <tr>
             <td>          
                <button id="cancelar" class="btn btn_regular btn_hoy"  title="Cancelar">Cancelar</button>
                <button id="guardar" class="btn btn_regular citas_pac" title="Aplicar">Aplicar</button>
             </td>    
           </tr>  
         </table>
        </form>
    </div>

{% endblock %}

{% block body -%}
    
{% endblock %}

{% block emergente -%}
    <div id="deshabilitar"></div>
    <div id="pop_citas"></div>
{% endblock %}
    
{% block script %}
    <script>
        var idtr;
        var fecha, fecha_mes;
        var estado_cupo;
        var login = $('#nombre_usr label').attr('id');
        
        $(document).ready(function() {
                                 
           var date = new Date();
           //alert('index-date: '+date);
           formato_fecha(date);
           var href = Routing.generate('cita_dia', {date: fecha, login:login});
           $('#area_trabajo').load(href);
        
           //var date = new Date();           
           //$('#cal_next').empty()
           //              .append(convertir_dia(date.getDay())+', '+date.getDate()+' '+convertir_mes(date.getMonth())+' '+date.getFullYear());
           $('#busq_fecha1').Zebra_DatePicker({
                format: 'Y-m-d',
                pair: $('#busq_fecha2')
           });
           $('#busq_fecha2').Zebra_DatePicker({
                direction: 1,
                show_clear_date: false,
                show_select_today: false,
           });
        });
        
        $('#botones_modulo').on('click','label:not(.checked)',function(){
            var label = $(this);
            var input = $('#' + label.attr('for'));            
            var href  = label.attr('href');
            
            //alert(label.attr('for'));
            
            if(!input.prop('checked')){
                label.closest('.menu_grupo').find("label").removeClass('checked');
                label.addClass('checked');
                input.prop('checked', true);
                
                if(label.attr('for') === 'input_dia'){                    
                    //alert(fecha);
                    var href = Routing.generate('cita_dia', {date: fecha,login:login});
                    $('#area_trabajo').load(href);                    
                }
                else if(label.attr('for') === 'input_mes'){
                    m = fecha_mes.substring(5,7), y = fecha_mes.substring(0,4);
                    ult_dia = new Date(y, m, 0).getDate();
                    
                    var href = Routing.generate('cita_mes', {f_inicio: y+'-'+m+"-01", f_fin: y+'-'+m+'-'+ult_dia});
                    //alert(href);
                    $('#area_trabajo').load(href);
                }
                else{
                    //alert(href);
                    $('#area_trabajo').load(href);
                }    
                //$('#citas').load(href);
            }
        });
        
        /*$('.btn_hoy').click(function(){
            var date = new Date();
            formato_fecha(date);
            
            if( $('.menu_grupo .primero').hasClass('checked') )
                $('#area_trabajo').load( $('.menu_grupo .primero').attr('href') );
            else if( $('.menu_grupo .ultimo').hasClass('checked') ){
                $('#cal_next').empty()
                              .append(convertir_dia(date.getDay())+', '+date.getDate()+' '+convertir_mes(date.getMonth())+' '+date.getFullYear());
                          
                var href = Routing.generate('cita_dia', {date: fecha});
                $('#area_trabajo').load(href);
            }
        });*/
        
        $('#botones_modulo').on('click','#hoy',function(){
            //alert('Hoy !');
            var date = new Date();
            formato_fecha(date);
            
            if( $('.menu_grupo .primero').hasClass('checked') ){
                m = fecha_mes.substring(5,7), y = fecha_mes.substring(0,4);
                ult_dia = new Date(y, m, 0).getDate();
                    
                var href = Routing.generate('cita_mes', {f_inicio: y+'-'+m+"-01", f_fin: y+'-'+m+'-'+ult_dia});
                    //alert(href);
                $('#area_trabajo').load(href);
            }    
            else if( $('.menu_grupo .ultimo').hasClass('checked') ){
                $('#cal_next').empty()
                              .append(convertir_dia(date.getDay())+', '+date.getDate()+' '+convertir_mes(date.getMonth())+' '+date.getFullYear());
                          
                var href = Routing.generate('cita_dia', {date: fecha,login:login});
                $('#area_trabajo').load(href);
            }
            else{
                var href = Routing.generate('cita_semana',{login:login});
                    $('#area_trabajo').load(href);                
            }
        });        
        
        function consultar_cita(){
            $('.wrapper').on('click','.view',function() {                         
                        //Recuperar el atributo href del enlace actual 
                        var href = $(this).attr('href'); 
                        // crear un elemento para colocar la información 
                        $('#deshabilitar').fadeIn('slow'); 
                        $('#pop_citas').fadeIn("slow");
                        // cargar mediante una llamada ajax la dirección que tiene href dentro de resultado 
                        $('#pop_citas').empty().load(href); 
                        // Para que no haga el comportamiento normal del enlace y cargue la página 
                        return false;                        
                    
               });
        }        
        
        $('#botones_modulo').on('click','#nuevo',function(){
            //alert('Nuevo !');
            var href = $(this).attr('href');
            $('#area_trabajo').empty().load(href);
            
            $('#cal_next').empty();
            $('#botones_modulo').empty().append(
                    '<div class="menu_grupo">'+                    
                    '<button class="btn btn_regular btn_hoy" id="cancelar" title="Cancelar">Cancelar</button>'+
                    '<button type="submit" class="btn btn_regular" id="guardar" title="Guardar">Guardar</button>'+
                    //'<button type="submit" class="btn btn_regular" id="guardar" title="Guardar" onclick="document.getElementById(\'crear_cita\').submit();">Guardar</button>'+
                    '</div>' 
            );
        });
        
        $('#botones_modulo').on('click','.menu_grupo #guardar',function(){
            //$count;
            $.getJSON(Routing.generate('ci_consultar')+'/'+$('#hnr_sircimbundle_citatype_idSolicitud_idMntExpediente').val()+'/'+$('#hnr_sircimbundle_citatype_idSolicitud_soFecha').val()+'/'+$('#hnr_sircimbundle_citatype_idSolicitud_soHora').val(),
                                            function(data) {
                                                $.each(data.regs, function(indice, reg) {
                                                    $count = reg;
                                                });
                                            });
            //alert(Routing.generate('ci_consultar')+
            //      '/'+$('#hnr_sircimbundle_citatype_idSolicitud_idMntExpediente').val()+'/'+$('#hnr_sircimbundle_citatype_idSolicitud_soFecha').val()+'/'+$('#hnr_sircimbundle_citatype_idSolicitud_soHora').val());
            
            $('#deshabilitar').fadeIn('slow'); 
            alertify.confirm("¿ Está seguro de realizar esta operación ?", function (e) { 
                if (e) { 
                    if( !$('#hnr_sircimbundle_citatype_idSolicitud_idMntExpediente').val()  
                     || !$('#hnr_sircimbundle_citatype_idSolicitud_Nombre').val() 
                     || !$('#hnr_sircimbundle_citatype_idSolicitud_idMntAtenAreaModEstab').val()
                     || !$('#hnr_sircimbundle_citatype_idSolicitud_EstudioArea').val()
                     || !$('#hnr_sircimbundle_citatype_idSolicitud_soRegion').val()
                     || !$('#hnr_sircimbundle_citatype_idSolicitud_soPosicion').val()
                     || !$('#hnr_sircimbundle_citatype_idSolicitud_soFecha').val()
                     || !$('#hnr_sircimbundle_citatype_idSolicitud_soHora').val()){
                        mensaje_error('¡ Existen campos sin llenar !');
                    }
                    else if($count > 0){
                        mensaje_error('¡ El paciente ya posee una cita programada para esa fecha y hora !');
                    }
                    else{
                        $('#crear_cita').submit();
                    }    
                        $('#deshabilitar').fadeOut('slow'); 
                } 
                else{ 
                    $('#deshabilitar').fadeOut('slow');
                } 
            });
            //$('#crear_cita').submit();
            
            //var href = Routing.generate('cita_dia', {date: fecha});
            //$('#area_trabajo').load(href);
        });
        
        $('#botones_modulo').on('click','.menu_grupo #cancelar',function(){
            var href = Routing.generate('cita_dia', {date: fecha, login:login});
            $('#area_trabajo').load(href);
            $('#botones_modulo').empty().append(
                    '<div class="menu_grupo">'+
                        '<button class="btn btn_destacado" id="buscar" title="Buscar"></button>'+
                        '<button class="btn btn_destacado" id="nuevo" title="Nueva cita" href="{{ path('cita_new',{'login':login}) }}"></button>'+
                    '</div>'+
                    
                    
                    '<div class="menu_grupo">'+ 
                        '<input type="radio" id="input_mes" name="toggle"/>'+
                        '<label class="btn btn_regular btn_toggle primero" for="input_mes">Mes</label>'+
                        '<input type="radio" id="input_semana" name="toggle"/>'+
                        '<label class="btn btn_regular btn_toggle medio" for="input_semana" href="{{ path('cita_semana',{'login':login}) }}">Semana</label>'+
                        '<input type="radio" id="input_dia" name="toggle" checked="checked"/>'+
                        '<label class="btn btn_regular btn_toggle ultimo checked" for="input_dia">Día</label>'+
                    '</div>'+
                    
                    
                    '<div class="menu_grupo">'+ 
                        '<button class="btn btn_regular btn_hoy" id="hoy" title="Hoy">Hoy</button>'+    
                    '</div>'+
                    
                    '<div id="busqueda"><form><table>'+
                        '<tr><td>Paciente :</td><td><input type="text" id="busq_registro"/></td></tr>'+
                        '<tr><td><input type="checkbox" name="checkbox" id="checkbox_id2" value="value"/><label for="checkbox_id2"><span></span>Estudio :</label></td>'+
                             '<td><select name="Single-line ListBox example" id="busq_estudio"><option value="1">Ultrasonografía</option><option value="2">Tránsito intestinal</option></select></td></tr>'+
                        '<tr><td><input type="checkbox" name="checkbox" id="checkbox_id3" value="value"/><label for="checkbox_id3"><span></span>Rango de fechas :</label></td>'+
                             '<td><input type="text" id="busq_fecha1" class="fecha_rango"/> - <input type="text" id="busq_fecha2" class="fecha_rango"/></td></tr>'+
                        '<tr><td><input type="checkbox" name="checkbox" id="checkbox_id4" value="value"/><label for="checkbox_id4"><span></span>Estado :</label></td>'+
                             '<td><select id="busq_estado" name="Single-line ListBox example"><option value="Pendiente">Pendiente</option><option value="Asistida">Asistida</option><option value="No Asistida">No Asistida</option><option value="Cancelada">Cancelada</option></select></td></tr>'+
                        '<tr><td><button id="cancelar" class="btn btn_regular btn_hoy"  title="Cancelar">Cancelar</button><button id="guardar" class="btn btn_regular citas_pac" title="Aplicar">Aplicar</button></td></tr>'+
                    '</table></form></div>'    
            );
                
            $('#busq_fecha1').Zebra_DatePicker({
                format: 'Y-m-d',
                pair: $('#busq_fecha2')
           });
           $('#busq_fecha2').Zebra_DatePicker({
                direction: 1,
                show_clear_date: false,
                show_select_today: false,        
           });   
                
        });
        
        
        

        /*$('#nuevo').click(function() { 
                    
            var href = $(this).attr('href');
            //alert(href);
            // cargar mediante una llamada ajax la dirección que tiene href dentro de resultado 
            $('#botones_modulo').empty().append(
                    '<div class="menu_grupo">'+
                    '<button class="btn btn_regular btn_hoy" id="cancelar" title="Cancelar">Cancelar</button>'+
                    '</div>' 
            ); 
            
            $('#area_trabajo')
                    .load(href);
                    //.load(href+' .form_cita',function(){
                        /*$('#hnr_sircimbundle_citatype_idSolicitud_idMntExpediente').keyup(function(){
                            $parameters = '?numExpediente=' + $(this).val();
            
                            $.getJSON(Routing.generate('get_infopaciente')+$parameters,
                                    function(data) {
                                        $.each(data.regs, function(indice, reg) {
                                            $('#hnr_sircimbundle_citatype_idSolicitud_Nombre').val( reg.Nombre );
                                            $('#hnr_sircimbundle_citatype_ciEdadPaciente').val( reg.Edad );                            
                                        });
                                    });
                        })
                    });
                    /*.delegate('#hnr_sircimbundle_citatype_idSolicitud_idMntExpediente','keyup',function(){
                        alert('funca');
                    });*/
            // Para que no haga el comportamiento normal del enlace y cargue la página 
           // return false;                        
                    
        //});
       
        
        function convertir_dia($dia){
            //alert('dia: '+$dia);
            switch($dia){
                case 0: $dia = 'Domingo';   break;
                case 1: $dia = 'Lunes';     break;
                case 2: $dia = 'Martes';    break;
                case 3: $dia = 'Miercoles'; break;
                case 4: $dia = 'Jueves';    break;
                case 5: $dia = 'Viernes';   break;
                case 6: $dia = 'Sábado';    break;    
            }
            return $dia;
        }
        function convertir_mes($mes){            
            //alert('mes: '+$mes);
            switch($mes){
                case 0:  $mes = 'Enero';      break;
                case 1:  $mes = 'Febrero';    break;
                case 2:  $mes = 'Marzo';      break;
                case 3:  $mes = 'Abril';      break;
                case 4:  $mes = 'Mayo';       break;
                case 5:  $mes = 'Junio';      break;
                case 6:  $mes = 'Julio';      break;
                case 7:  $mes = 'Agosto';     break;
                case 8:  $mes = 'Septiembre'; break;
                case 9:  $mes = 'Octubre';    break;
                case 10: $mes = 'Noviembre';  break;
                case 11: $mes = 'Diciembre';  break;    
            }
            return $mes;
        }
        
        function formato_fecha(date){
            if( date.getDate() < 10 ){
                $dia = '0'+ date.getDate();                
            }
            else{
                $dia = date.getDate();
            }            
            if( (date.getMonth()+1) < 10 ){
                $mes = '0' + (date.getMonth()+1);                
            }
            else{
                $mes = date.getMonth()+1;
            }
            fecha = date.getFullYear() +'-'+ $mes +'-'+ $dia;
            fecha_mes = fecha;
            //alert('index-formato-fecha(UTC): '+fecha);
        }
        
/************************************************************************************/
/************************* Busqueda de citas por paciente ***************************/
/************************************************************************************/
        
        $('#botones_modulo').on('click','#buscar',function(){
            var div = $('#busqueda');
            //alert(div.css('visibility'));
	    if( div.css('visibility') == 'hidden' ){
	        div.css('visibility','visible');
            }    
	    else{
	        div.css('visibility','hidden');
                $('#busqueda form').trigger('reset');
            }
	});
        
        $('#botones_modulo').on('click','.citas_pac',function(){
          var query = 'SELECT cita FROM hnrsircimBundle:Cita cita'+
                      ' JOIN cita.idSolicitud sol'+
                      ' JOIN sol.idEstudioArea area'+
                         ' WHERE sol.id = cita.idSolicitud'+
                         ' AND area.idArea = :area';
          
          if($('#busq_registro').val() != ''){
            //query = 'select * from solicitud where id_mnt_expediente = \''+$('#busq_registro').val()+'\'';
            query += ' AND sol.idMntExpediente = \''+ $('#busq_registro').val() +'\'';
            
            if($('#busqueda').find('#checkbox_id2').is(':checked'))
                query += ' and sol.idEstudioArea = '+ $('#busq_estudio').val();
            if($('#busqueda').find('#checkbox_id3').is(':checked')){
                var fecha1 = new Date($('#busq_fecha1').val());
                var fecha2 = new Date($('#busq_fecha2').val());
                if (fecha1 < fecha2){
                    query += ' and sol.soFecha between \''+ $('#busq_fecha1').val() +'\' and \''+ $('#busq_fecha2').val() +'\'';
                }
                else{
                    mensaje_error('¡ Ingrese un rango de fechas valido !');
                    return false;
                }                    
            }
            if($('#busqueda').find('#checkbox_id4').is(':checked'))
                query += ' and cita.ciEstado = \''+ $('#busq_estado').val() +'\'';
            
            query += ' ORDER BY sol.soFecha DESC, sol.soHora DESC';
            
            var href = Routing.generate('citas_paciente', {query: query, registro: $('#busq_registro').val()});
            $('#area_trabajo').load(href, function(){
                consultar_cita();
            });
            
            $('#cal_next').empty();            
            $('#botones_modulo').empty().append(
                    '<div class="menu_grupo">'+                    
                    '<button class="btn btn_regular btn_hoy" id="cancelar" title="Volver">Volver</button>'+
                    '</div>' 
            );
          }
          else{
            mensaje_error('Ingrese el Número de registro de un paciente !');  
          }
          //alert(query);
          return false;
        });
        
        $('#botones_modulo').on('click','#busqueda #cancelar',function(){
            var div = $('#busqueda');
            div.css('visibility','hidden');
            
            $('#busqueda form').trigger('reset');
            
            return false;
        });
    </script>
{% endblock %}